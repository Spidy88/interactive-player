<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../iron-autogrow-textarea/iron-autogrow-textarea.html">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-alpha1/jquery.min.js"></script>
<script src="vendor/Vimeo-jQuery-API-0.10.1/dist/jquery.vimeo.api.min.js"></script>
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>

<dom-module id="interactive-player">
  <template>
    <style>
      /*#video {
        display: block;
        width: 65%;
        margin-right: auto;
        margin-left: auto;
      }*/

      /*#sidebar {
        width: 35%;
        flex-direction: column;
        visibility: collapse;
      }*/

      #comment-list {
        display: block;
        width: 100%;
        height: 70%;
        margin-right: auto;
        margin-left: auto;
        background-color: #FFF;
      }

      #input-block {
        width: 100%;
        height: 30%;
        flex-direction: column;
      }
      .comment {
        border-bottom: 1px solid gray;
      }

      span {
        font-family: "Source Sans Pro","Helvetica Neue", Helvetica, Arial, sans-serif;
        font-size: .8em;
        font-weight: bold;
        margin-left: .25em; 
      }

      .message {
        font-family: "Source Sans Pro","Helvetica Neue", Helvetica, Arial, sans-serif;
        font-size: .75em;
        margin-left: .25em;
        color: gray;
      }

      #container, #sidebar {
        display: flex;
        height: 500px;
      }


      .selected {
        background-color: sandybrown;
      }

      iron-autogrow-textarea {
        width: 99%;
        height: 50%;
        text-align: left;
        background-color: white;
        font-family: "Source Sans Pro","Helvetica Neue", Helvetica, Arial, sans-serif;
      }
      
      button {
        border: 1px solid transparent;
        font-family: "Helvetica Neue",Helvetica,Helvetica,Arial,sans-serif;
        font-weight: 700;
        font-size: 1em;
        color: white;
        display: block;
        width: 100%;
        height: 24%;
      }

      .highlight-on {
        background-color: #3adb76;
      }

      .highlight-on:hover {
        background-color: #17D05C;
      }

      .highlight-off {
        background-color: #ff5a56;
      }

      .highlight-off:hover {
        background-color: #ff1612;
      }      
      
      .submit {
        background-color: #0298f5;
      }

      .submit:hover {
        background-color: #027dc4;
      } 

      /*Experimental styles*/

      #container {
        position: relative;
        overflow: hidden;
        width: 100%;
      }

      #slider {
        width: 60%;
        height: 100%;
        position: relative;
        -webkit-transform: translateX(0);
        transform: translateX(0);
        -webkit-transition: .3s ease all;
        transition: .3s ease all;
        padding: 0px;
      }

      iframe {
        width: 100%;
        height: 100%;
      }

      #sidebar {
        display: block;
        width: 300px;
        height: 100%;
        position: absolute;
        top: 0;
        left: -300px;
        overflow: scroll;
      }

      #container.show-nav #slider {
        -webkit-transform: translateX(300px);
        transform: translateX(300px);
      }

      .tab {
        padding: 6px;
        border-top-left-radius: 6px;
        border-top-right-radius: 6px;
        text-align: center;
        background-color: #add8e6;
        color: #00008b;
        border: 1px solid #00008b;
        font-family: Arial,sans-serif;
        height: 10%;
        width: 15%;
        position: relative;
        right: -95.4%;
        top: -57%;
        transform: rotate(90deg);
      }

    </style>
    <div id="container">
      <div id="slider">
        <iframe id="video" src="{{source}}" frameborder="0" allowfullscreen mozallowfullscreen webkitallowfullscreen>
        </iframe>  
        <div id="sidebar">
          <iron-list id="comment-list" selection-enabled items="{{comments}}">
            <template>
              <div class="comment"  moment="{{item.createdAt}}">
                <span>{{item.author}}</span>
                <div class="message">{{item.text}}<div>@{{item.createdAt}}</div></div>
              </div>
            </template>
          </iron-list>
          <div id="input-block">
            <iron-autogrow-textarea id="comment-input" bind-value="{{user-input}}" on-click="beginEditing" placeholder="Write something helpful!" max-rows="4"></iron-autogrow-textarea>
            <button class="submit" on-click="createComment">Add comment!</button>
            <button class="highlight-on" on-click="toggleHighlight">Comment highlighting: ON</button>
          </div>
        </div>
        <button class="tab" on-click="toggleComments">Show Comments</button>
      </div>
    </div> 
  </template>
</dom-module>
<script>
  //Define Polymer element
  Polymer({
    is: 'interactive-player',
    properties: {
      /** 
      *  The `comments` attribute expects an array of objects containing the video comments and the following data about 
      *  them: 
      *  `author` - (String) name of the user who wrote the comment 
      *  `text` - provided by player in comment creation
      *  `createdAt` - provided by player in comment creation
      *  was made
      *****/
      comments: {
        type: Array,
      },
      /**
      * URL of the Vimeo video to be used
      * @type String 
      **/
      source: {
        type: String,
        value: "https://player.vimeo.com/video/89662194?api=1"
      },
      /**
      * A decimal number representing the location (percentage) in the video where the comment. Used in 
      * comment animations.
      **/
      location: {
        type: Number,
        value: 0
      },
      /**
      * Comment entered in by the user. 
      **/
      "user-input": {
        type: String
      },
      /**
      * Boolean controlling comment highlighting. Default to true. 
      **/
      highlight: {
        type: Boolean,
        value: true
      },
      /**
      * Boolean controlling use of new location for comment creation.
      **/
      editing: {
        type: Boolean,
        value: false
      },
      /**
      * Number (decimal) representing the location of the video where the comment was initiated. 
      **/
      "new-comment-location": {
        type: Number
      }
    },
    /**
    * On insertion into the document, the player esablishes a listener for the video's progress so that
    * it can perform various functions based on the moment of the video. 
    **/
    attached: function(){
      var component = this;
     
      $('#video').on("playProgress", function(event, data){
        //If highlighting is enabled, selectRelevant at each moment
        if(component.highlight){
          component.selectRelevant(data.percent);
        }
        //Update component's location property on any progress. 
        component.location = data.percent;
      });
    },
    /**
     * Highlights relevant comments based on the video location. 
     *
     * @param {number} the video's current location, as a percentage
     */
    selectRelevant: function(percent){
      var list = $('iron-list')[0].getEffectiveChildren();
      //If there is a comment with a video % === current %
      for(var i = 1; i <list.length; i++){
        //Add some 
        if(percent >= list[i].moment && list[i].moment * 1.1 >= percent){
        //Add selected class to that comment
          this.toggleClass('selected', true, list[i]);
        } else {
          this.toggleClass('selected', false, list[i]);
        }
      }
    },
    /**
    * Creates a comment object consisting of the new-comment-location and user-input 
    * Comment data is passed to the environment as event detail 
    * 
    * @event new-comment
    * @detail {{
        text: string,
        createdAt: number
      }}
    */
    createComment: function(){
      var comment = {
        text: this['user-input'],
        createdAt: this["new-comment-location"]
      };

      this.fire('new-comment', comment);

      //Clear input and reset editing status
      this['user-input'] = '';
      this.editing = false;
    },
    /**
    * Adds or removes an element's higlight
    **/
    toggleHighlight: function(){
      //Reverse highlight boolean
      this.highlight = !this.highlight;
      //If highlighting is being turned off, remove active highlights
      if(!this.highlight){
        var list = $('iron-list')[0].getEffectiveChildren();
        for(var i = 0; i < list.length; i++){
          this.toggleClass('selected', false, list[i]);
        }
      }

      if(this.highlight){
        $('.highlight-off').addClass('highlight-on').removeClass('highlight-off');
        $('.highlight-on').text('Comment highlighting: ON');
      } else {
        $('.highlight-on').addClass('highlight-off').removeClass('highlight-on');
        $('.highlight-off').text('Comment highlighting: OFF');
      }
    },
    /**
    * Creates an editing session when the user clicks the new comment input 
    **/
    beginEditing: function(){
      if(this.editing){ 
        return; 
      }

      this.editing = true;
      this["new-comment-location"] = this.location;
    },
    toggleComments: function(){
      if($('#container').hasClass('show-nav')){
        $('#container').removeClass('show-nav');
      } else {
        $('#container').addClass('show-nav');
      }
    }
  });
</script>